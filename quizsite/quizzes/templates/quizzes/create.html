{% extends 'base.html' %}

{% block title %}Create Quiz{% endblock %}

{% block content %}
<div class="container" style="max-width: 1000px;">
	<h1>Create Quiz</h1>
	{% if error %}
	<div class="alert alert-danger">{{ error }}</div>
	{% endif %}
	<form method="post" id="create-quiz-form">
		{% csrf_token %}
		<div class="card" style="padding: 16px; margin-bottom: 16px;">
			<div style="display:flex; justify-content: space-between; align-items:center;">
				<h3 style="margin:0;">Gemini AI Draft</h3>
				<button type="button" class="btn btn-primary" id="aiGenerateBtn">
					<span class="ai-btn-label">✨ Generate with Gemini</span>
				</button>
			</div>
			<p class="text-muted" style="margin: 8px 0 16px;">
				Set your constraints and let Gemini propose a quiz draft. You can still edit every field before saving.
			</p>
			<div class="form-row" style="display:grid; grid-template-columns: repeat(auto-fit,minmax(200px,1fr)); gap: 12px;">
				<div>
					<label>Topic / Focus</label>
					<input type="text" name="ai_topic" class="form-control" placeholder="e.g. Solar System" />
				</div>
				<div>
					<label>Difficulty</label>
					<select name="ai_difficulty" class="form-control">
						<option value="easy">Easy</option>
						<option value="medium" selected>Medium</option>
						<option value="hard">Hard</option>
					</select>
				</div>
				<div>
					<label>Desired Questions</label>
					<input type="number" name="ai_question_count" class="form-control" min="1" value="5" />
				</div>
			</div>
			<div id="aiStatus" class="text-muted small" style="margin-top:10px;">
				Gemini will populate the form with a full quiz draft based on the details you provide below.
			</div>
		</div>

		<div class="card" style="padding: 16px; margin-bottom: 16px;">
			<h3>Quiz Details</h3>
			<div class="form-group" style="margin-bottom: 10px;">
				<label>Title</label>
				<input type="text" name="title" class="form-control" required />
			</div>
			<div class="form-group" style="margin-bottom: 10px;">
				<label>Description</label>
				<textarea name="description" class="form-control" rows="3"></textarea>
			</div>
			<div class="form-row" style="display: grid; grid-template-columns: repeat(auto-fit,minmax(200px,1fr)); gap: 12px;">
				<div>
					<label>Mode</label>
					<select name="mode" class="form-control">
						<option value="test">Test</option>
						<option value="practice">Practice</option>
						<option value="competition">Competition</option>
					</select>
				</div>
				<div>
					<label>Duration (minutes)</label>
					<input type="number" name="duration" class="form-control" min="1" value="10" />
				</div>
				<div>
					<label>Max Questions (optional)</label>
					<input type="number" name="max_questions" class="form-control" min="1" />
				</div>
			</div>
			<div class="form-row" style="display: grid; grid-template-columns: repeat(auto-fit,minmax(250px,1fr)); gap: 12px; margin-top: 10px;">
				<div>
					<label>Start Date & Time</label>
					<input type="datetime-local" name="start_time" class="form-control" required />
				</div>
				<div>
					<label>End Date & Time</label>
					<input type="datetime-local" name="end_time" class="form-control" required />
				</div>
			</div>
			<div class="form-group" style="margin-top: 10px;">
				<label>Access Token (optional)</label>
				<input type="text" name="access_token" class="form-control" placeholder="Require token to attempt this quiz" />
			</div>
		</div>

		<div class="card" style="padding: 16px;">
			<div style="display:flex; justify-content: space-between; align-items:center;">
				<h3>Questions</h3>
				<button type="button" class="btn btn-secondary" onclick="addQuestion()">➕ Add Question</button>
			</div>
			<div id="questions"></div>
		</div>

		<div style="margin-top: 16px; display:flex; gap:8px;">
			<a href="{% url 'home' %}" class="btn btn-outline-secondary">Cancel</a>
			<button type="submit" class="btn btn-primary">Create Quiz</button>
		</div>
	</form>
</div>

<script>
let questionCount = 0;

function addQuestion(prefill = null) {
	questionCount += 1;
	const qIndex = questionCount;
	const container = document.getElementById('questions');
	const wrapper = document.createElement('div');
	wrapper.className = 'question-block';
	wrapper.style = 'border:1px solid #e0e0e0; padding:12px; border-radius:8px; margin-top:12px;';
	wrapper.setAttribute('data-qindex', qIndex);
	wrapper.innerHTML = `
		<div style="display:flex; gap:8px; justify-content: space-between; align-items:center;">
			<h4 style="margin:0;">Question #${qIndex}</h4>
			<button type="button" class="btn btn-sm btn-outline-danger" onclick="removeQuestion(${qIndex})">Remove</button>
		</div>
		<div class="form-group" style="margin-top:8px;">
			<label>Question Text</label>
			<textarea name="question_text_${qIndex}" class="form-control" rows="2" required></textarea>
		</div>
		<div class="form-row" style="display:grid; grid-template-columns: repeat(auto-fit,minmax(180px,1fr)); gap:12px;">
			<div>
				<label>Type</label>
				<select name="question_type_${qIndex}" class="form-control" onchange="toggleOptions(${qIndex}, this.value)">
					<option value="mcq" selected>MCQ</option>
					<option value="text">Text</option>
				</select>
			</div>
			<div>
				<label>Marks</label>
				<input type="number" name="question_marks_${qIndex}" class="form-control" min="1" value="1" />
			</div>
		</div>
		<div id="options_${qIndex}" class="options" style="margin-top:8px;">
			<label>Options</label>
			<div id="option_list_${qIndex}"></div>
			<div style="margin-top:6px;">
				<button type="button" class="btn btn-sm btn-secondary" onclick="addOption(${qIndex})">Add Option</button>
			</div>
		</div>
	`;
	container.appendChild(wrapper);

	const textField = wrapper.querySelector(`textarea[name="question_text_${qIndex}"]`);
	const typeField = wrapper.querySelector(`select[name="question_type_${qIndex}"]`);
	const marksField = wrapper.querySelector(`input[name="question_marks_${qIndex}"]`);

	if (prefill?.text) {
		textField.value = prefill.text;
	}
	if (prefill?.marks) {
		marksField.value = prefill.marks;
	}
	if (prefill?.qtype) {
		typeField.value = prefill.qtype;
	}

	const hasPrefillOptions = Array.isArray(prefill?.options) && prefill.options.length > 0;

	if (prefill?.qtype === 'text') {
		toggleOptions(qIndex, 'text');
	} else if (hasPrefillOptions) {
		const list = document.getElementById(`option_list_${qIndex}`);
		list.innerHTML = '';
		prefill.options.forEach(option => addOption(qIndex, option));
	} else {
		addOption(qIndex);
		addOption(qIndex);
	}

	toggleOptions(qIndex, typeField.value);
}

function removeQuestion(qIndex) {
	const block = document.querySelector(`.question-block[data-qindex='${qIndex}']`);
	if (block) block.remove();
}

function toggleOptions(qIndex, type) {
	const opt = document.getElementById(`options_${qIndex}`);
	if (!opt) return;
	if (type === 'mcq') {
		opt.style.display = 'block';
		if (!document.getElementById(`option_list_${qIndex}`).children.length) {
			addOption(qIndex);
			addOption(qIndex);
		}
	} else {
		opt.style.display = 'none';
	}
}

function addOption(qIndex, optionPrefill = null) {
	const list = document.getElementById(`option_list_${qIndex}`);
	const optIndex = list.children.length + 1;
	const row = document.createElement('div');
	row.style = 'display:flex; gap:8px; align-items:center; margin-bottom:6px;';
	row.innerHTML = `
		<input type="radio" name="correct_${qIndex}" value="${optIndex}" title="Mark correct" />
		<input type="text" class="form-control" name="option_${qIndex}_${optIndex}" placeholder="Option ${optIndex}" style="flex:1;" required />
		<button type="button" class="btn btn-sm btn-outline-danger" onclick="this.parentElement.remove()">✖</button>
	`;
	list.appendChild(row);
	if (optionPrefill) {
		const textInput = row.querySelector('input[type="text"]');
		const radioInput = row.querySelector('input[type="radio"]');
		textInput.value = optionPrefill.text || '';
		if (optionPrefill.is_correct) {
			radioInput.checked = true;
		}
	}
}

function resetQuestions() {
	const container = document.getElementById('questions');
	container.innerHTML = '';
	questionCount = 0;
}

function getCsrfToken() {
	const match = document.cookie.split('; ').find(row => row.startsWith('csrftoken='));
	return match ? match.split('=')[1] : '';
}

function updateAIStatus(message, isError = false) {
	const statusEl = document.getElementById('aiStatus');
	if (!statusEl) return;
	statusEl.textContent = message;
	statusEl.classList.toggle('text-danger', isError);
	statusEl.classList.toggle('text-success', !isError);
	statusEl.classList.toggle('text-muted', !message);
}

function applyAiQuiz(data) {
	const titleInput = document.querySelector('input[name="title"]');
	const descInput = document.querySelector('textarea[name="description"]');
	const durationInput = document.querySelector('input[name="duration"]');
	const maxQuestionsInput = document.querySelector('input[name="max_questions"]');

	if (data.title && titleInput) titleInput.value = data.title;
	if (data.description && descInput) descInput.value = data.description;
	if (data.duration && durationInput) durationInput.value = data.duration;
	if (maxQuestionsInput) {
		maxQuestionsInput.value = data.max_questions || '';
	}

	resetQuestions();
	(data.questions || []).forEach(question => addQuestion(question));
}

async function handleAIGenerate() {
	const button = document.getElementById('aiGenerateBtn');
	const label = button?.querySelector('.ai-btn-label');
	const topic = document.querySelector('input[name="ai_topic"]').value.trim();
	const title = document.querySelector('input[name="title"]').value.trim();

	if (!topic && !title) {
		updateAIStatus('Provide at least a topic or title for Gemini to work with.', true);
		return;
	}

	button.disabled = true;
	if (label) label.textContent = 'Generating...';
	updateAIStatus('Talking to Gemini, please wait...');

	const payload = {
		topic,
		title,
		description: document.querySelector('textarea[name="description"]').value,
		difficulty: document.querySelector('select[name="ai_difficulty"]').value,
		question_count: document.querySelector('input[name="ai_question_count"]').value,
		duration: document.querySelector('input[name="duration"]').value,
		max_questions: document.querySelector('input[name="max_questions"]').value,
		start_time: document.querySelector('input[name="start_time"]').value,
		end_time: document.querySelector('input[name="end_time"]').value,
	};

	try {
		const response = await fetch("{% url 'generate_quiz_ai' %}", {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json',
				'X-CSRFToken': getCsrfToken(),
			},
			body: JSON.stringify(payload),
		});
		const data = await response.json();
		if (!response.ok) {
			throw new Error(data.error || 'Gemini could not create a quiz.');
		}
		applyAiQuiz(data);
		updateAIStatus('Draft ready! Review and customize before publishing.', false);
	} catch (error) {
		console.error(error);
		updateAIStatus(error.message || 'Something went wrong with Gemini.', true);
	} finally {
		button.disabled = false;
		if (label) label.textContent = '✨ Generate with Gemini';
	}
}

document.addEventListener('DOMContentLoaded', () => {
	addQuestion();
	const aiButton = document.getElementById('aiGenerateBtn');
	if (aiButton) {
		aiButton.addEventListener('click', handleAIGenerate);
	}
});
</script>
{% endblock %}
