{% extends 'base.html' %}

{% block title %}Create Quiz{% endblock %}

{% block content %}
<div class="container" style="max-width: 1000px;">
	<h1>Create Quiz</h1>
	{% if error %}
	<div class="alert alert-danger">{{ error }}</div>
	{% endif %}
	<form method="post">
		{% csrf_token %}
		<div class="card" style="padding: 16px; margin-bottom: 16px;">
			<h3>Quiz Details</h3>
			<div class="form-group" style="margin-bottom: 10px;">
				<label>Title</label>
				<input type="text" name="title" class="form-control" required />
			</div>
			<div class="form-group" style="margin-bottom: 10px;">
				<label>Description</label>
				<textarea name="description" class="form-control" rows="3"></textarea>
			</div>
			<div class="form-row" style="display: grid; grid-template-columns: repeat(auto-fit,minmax(200px,1fr)); gap: 12px;">
				<div>
					<label>Mode</label>
					<select name="mode" class="form-control">
						<option value="test">Test</option>
						<option value="practice">Practice</option>
						<option value="competition">Competition</option>
					</select>
				</div>
				<div>
					<label>Duration (minutes)</label>
					<input type="number" name="duration" class="form-control" min="1" value="10" />
				</div>
				<div>
					<label>Max Questions (optional)</label>
					<input type="number" name="max_questions" class="form-control" min="1" />
				</div>
			</div>
			<div class="form-row" style="display: grid; grid-template-columns: repeat(auto-fit,minmax(250px,1fr)); gap: 12px; margin-top: 10px;">
				<div>
					<label>Start Date & Time</label>
					<input type="datetime-local" name="start_time" class="form-control" required />
				</div>
				<div>
					<label>End Date & Time</label>
					<input type="datetime-local" name="end_time" class="form-control" required />
				</div>
			</div>
			<div class="form-group" style="margin-top: 10px;">
				<label>Access Token (optional)</label>
				<input type="text" name="access_token" class="form-control" placeholder="Require token to attempt this quiz" />
			</div>
		</div>

		<div class="card" style="padding: 16px;">
			<div style="display:flex; justify-content: space-between; align-items:center;">
				<h3>Questions</h3>
				<button type="button" class="btn btn-secondary" onclick="addQuestion()">➕ Add Question</button>
			</div>
			<div id="questions"></div>
		</div>

		<div style="margin-top: 16px; display:flex; gap:8px;">
			<a href="{% url 'home' %}" class="btn btn-outline-secondary">Cancel</a>
			<button type="submit" class="btn btn-primary">Create Quiz</button>
		</div>
	</form>
</div>

<script>
let questionCount = 0;

function addQuestion(prefill) {
	questionCount += 1;
	const qIndex = questionCount;
	const container = document.getElementById('questions');
	const wrapper = document.createElement('div');
	wrapper.className = 'question-block';
	wrapper.style = 'border:1px solid #e0e0e0; padding:12px; border-radius:8px; margin-top:12px;';
	wrapper.setAttribute('data-qindex', qIndex);
	wrapper.innerHTML = `
		<div style="display:flex; gap:8px; justify-content: space-between; align-items:center;">
			<h4 style="margin:0;">Question #${qIndex}</h4>
			<button type="button" class="btn btn-sm btn-outline-danger" onclick="removeQuestion(${qIndex})">Remove</button>
		</div>
		<div class="form-group" style="margin-top:8px;">
			<label>Question Text</label>
			<textarea name="question_text_${qIndex}" class="form-control" rows="2" required></textarea>
		</div>
		<div class="form-row" style="display:grid; grid-template-columns: repeat(auto-fit,minmax(180px,1fr)); gap:12px;">
			<div>
				<label>Type</label>
				<select name="question_type_${qIndex}" class="form-control" onchange="toggleOptions(${qIndex}, this.value)">
					<option value="mcq" selected>MCQ</option>
					<option value="text">Text</option>
				</select>
			</div>
			<div>
				<label>Marks</label>
				<input type="number" name="question_marks_${qIndex}" class="form-control" min="1" value="1" />
			</div>
		</div>
		<div id="options_${qIndex}" class="options" style="margin-top:8px;">
			<label>Options</label>
			<div id="option_list_${qIndex}"></div>
			<div style="margin-top:6px;">
				<button type="button" class="btn btn-sm btn-secondary" onclick="addOption(${qIndex})">Add Option</button>
			</div>
		</div>
	`;
	container.appendChild(wrapper);
	// Add two default options for MCQ
	addOption(qIndex);
	addOption(qIndex);
}

function removeQuestion(qIndex) {
	const block = document.querySelector(`.question-block[data-qindex='${qIndex}']`);
	if (block) block.remove();
}

function toggleOptions(qIndex, type) {
	const opt = document.getElementById(`options_${qIndex}`);
	if (type === 'mcq') {
		opt.style.display = 'block';
	} else {
		opt.style.display = 'none';
	}
}

function addOption(qIndex) {
	const list = document.getElementById(`option_list_${qIndex}`);
	const optIndex = list.children.length + 1;
	const row = document.createElement('div');
	row.style = 'display:flex; gap:8px; align-items:center; margin-bottom:6px;';
	row.innerHTML = `
		<input type="radio" name="correct_${qIndex}" value="${optIndex}" title="Mark correct" />
		<input type="text" class="form-control" name="option_${qIndex}_${optIndex}" placeholder="Option ${optIndex}" style="flex:1;" required />
		<button type="button" class="btn btn-sm btn-outline-danger" onclick="this.parentElement.remove()">✖</button>
	`;
	list.appendChild(row);
}

document.addEventListener('DOMContentLoaded', () => {
	addQuestion();
});
</script>
{% endblock %}
